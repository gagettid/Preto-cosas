<# 
    PRETORIAN — EJERCICIO CONTROLADO DE SEGURIDAD (LAB)
    ---------------------------------------------------
    Este script SIMULA la táctica MITRE ATT&CK T1486 (Data Encrypted for Impact)
    de forma SEGURA: comprime y renombra archivos para generar telemetría.
    NO realiza cifrado in-place ni ransomware real.
    :warning: DISCLAIMER (IMPORTANTE):
    - Uso EXCLUSIVO en LAB/DEMO con datos dummy.
    - No ejecutar en producción ni sobre datos reales.
    - Requiere confirmación consciente (marcador y/o -Confirm).
    - El operador es responsable de validar el entorno y permisos.
    Organización: PRETORIAN
#>
[CmdletBinding(SupportsShouldProcess = $true, ConfirmImpact = 'High')]
param(
  [Parameter(Mandatory = $true)][string]$TargetDir,
  [int]$ThrottleMs = 150,
  # Simulación/impacto
  [switch]$DeleteOriginals = $false,                 # Borra el archivo renombrado .locked_sim (solo recomendado en dummies)
  [switch]$Use7Zip = $false,                         # Usa 7-Zip (crea .7z con password)
  [string]$SevenZipPath = "C:\Program Files\7-Zip\7z.exe",
  [string]$Password = "TestOnly123!",
  # Revertir artefactos
  [switch]$Revert = $false,
  # Mínimo de archivos a procesar (genera dummies si faltan)
  [int]$MinFiles = 100,
  [switch]$AutoGenerateDummies = $true,
  # Seguridad extra: solo permitir borrar originales si están en _Dummies (recomendado)
  [switch]$ForceDeleteAll = $false                   # Si lo usas, permite borrar fuera de _Dummies (NO recomendado)
)
# ---------- SALVAGUARDAS ----------
if (-not (Test-Path $TargetDir -PathType Container)) { throw "TargetDir no existe o no es carpeta." }
$full = (Resolve-Path $TargetDir).Path
# Bloqueo de rutas peligrosas y verificación de profundidad
$danger = @("C:\","C:\Windows","C:\Program Files","C:\Program Files (x86)","C:\Users","C:\ProgramData")
if ($danger -contains $full) { throw "Se rechaza ejecutar en rutas de sistema/raíz: $full" }
if ((($full -split '[\\/]').Count) -lt 3) { throw "Ruta demasiado genérica. Usa una carpeta de LAB más profunda (p.ej. C:\Lab\DummyData)." }
# Marcador de seguridad: obliga a doble intención
$marker = Join-Path $full ".safe_to_encrypt"
if (-not $Revert -and -not (Test-Path $marker)) {
  Write-Host "SIMULACIÓN T1486. Creando marcador: $marker" -ForegroundColor Yellow
  "Solo proceder en LAB y con datos dummy. Vuelve a ejecutar para continuar." | Out-File -FilePath $marker -Encoding UTF8 -Force
  Write-Warning "Marcador creado. Ejecuta nuevamente el script para continuar la simulación."
  return
}
# ---------- HELPERS ----------
function Write-Note {
  $note = @"
==========================================
PRETORIAN — EJERCICIO CONTROLADO (LAB)
==========================================
Sus archivos fueron "cifrados" COMO PARTE DE UNA PRUEBA SEGURA DE LABORATORIO.
NO se realizó cifrado real; se aplicaron compresión y renombrado para TELEMETRÍA.
Si ve este mensaje fuera de un entorno de laboratorio, contacte a su equipo de seguridad.
Organización: PRETORIAN
Táctica simulada: MITRE ATT&CK T1486 (Data Encrypted for Impact)
Test ID: $(Get-Date -Format s)
==========================================
"@
  Set-Content -Path (Join-Path $full "READ_ME_TEST_RANSOM_NOTE.txt") -Value $note -Encoding UTF8 -Force
}
function Get-WorkFiles {
  Get-ChildItem -Path $full -File -Recurse -ErrorAction SilentlyContinue | Where-Object {
    $_.FullName -notmatch "(\.zip$|\.7z$|READ_ME_TEST_RANSOM_NOTE\.txt$|\.locked_sim$)"
  }
}
function Ensure-MinFiles {
  param(
    [Parameter(Mandatory = $true)][string]$Path,
    [int]$Min = 100,
    [switch]$AutoGenerate = $true
  )
  $existing = Get-ChildItem -Path $Path -File -Recurse -ErrorAction SilentlyContinue | Where-Object {
    $_.FullName -notmatch "(\.zip$|\.7z$|READ_ME_TEST_RANSOM_NOTE\.txt$|\.locked_sim$)"
  }
  $count = ($existing | Measure-Object).Count
  if ($count -ge $Min) { return $existing }
  if (-not $AutoGenerate) {
    throw "Se requieren al menos $Min archivos, pero hay $count."
  }
  $toMake = $Min - $count
  $dummyDir = Join-Path $Path "_Dummies"
  New-Item -ItemType Directory -Force -Path $dummyDir | Out-Null
  for ($i = 1; $i -le $toMake; $i++) {
    $name = "dummy_$i_" + [Guid]::NewGuid().ToString("N")
    $exts = @(".bin",".txt",".log",".dat",".cfg",".xml",".json",".csv")
    $target = Join-Path $dummyDir ($name + ($exts | Get-Random))
    $sizeKB = Get-Random -Minimum 32 -Maximum 128  # 32–128 KB
    $bytes = New-Object byte[] ($sizeKB * 1024)
    [System.Security.Cryptography.RandomNumberGenerator]::Create().GetBytes($bytes)
    [IO.File]::WriteAllBytes($target, $bytes)
  }
  Get-ChildItem -Path $Path -File -Recurse -ErrorAction SilentlyContinue | Where-Object {
    $_.FullName -notmatch "(\.zip$|\.7z$|READ_ME_TEST_RANSOM_NOTE\.txt$|\.locked_sim$)"
  }
}
# ---------- MODO REVERT ----------
if ($Revert) {
  Write-Host "Revirtiendo artefactos de simulación en $full ..." -ForegroundColor Cyan
  $renamed = Get-ChildItem -Path $full -Recurse -File | Where-Object { $_.Name -like "*.locked_sim" }
  foreach ($f in $renamed) {
    $orig = $f.FullName -replace "\.locked_sim$",""
    if ($PSCmdlet.ShouldProcess($f.FullName, "Rename to original")) {
      Rename-Item -Path $f.FullName -NewName ([IO.Path]::GetFileName($orig)) -Force
    }
    Start-Sleep -Milliseconds $ThrottleMs
  }
  $archives = Get-ChildItem -Path $full -Recurse -Include *.zip,*.7z -ErrorAction SilentlyContinue
  foreach ($a in $archives) {
    if ($PSCmdlet.ShouldProcess($a.FullName, "Remove archive")) {
      Remove-Item $a.FullName -Force -ErrorAction SilentlyContinue
    }
  }
  $notePath = Join-Path $full "READ_ME_TEST_RANSOM_NOTE.txt"
  if (Test-Path $notePath -PathType Leaf) {
    if ($PSCmdlet.ShouldProcess($notePath, "Remove ransom note")) {
      Remove-Item $notePath -Force -ErrorAction SilentlyContinue
    }
  }
  Write-Output "Reversión completa."
  return
}
# ---------- SIMULACIÓN ----------
Write-Host "Iniciando simulación T1486 en: $full" -ForegroundColor Green
Write-Note
$files = Ensure-MinFiles -Path $full -Min $MinFiles -AutoGenerate:$AutoGenerateDummies
if (-not $files -or $files.Count -eq 0) { Write-Output "No hay archivos para procesar."; return }
$use7z = $Use7Zip -and (Test-Path $SevenZipPath)
$processed = 0
foreach ($f in $files) {
  try {
    $zipPath = if ($use7z) {"$($f.FullName).7z"} else {"$($f.FullName).zip"}
    if ($use7z) {
      if ($PSCmdlet.ShouldProcess($f.FullName, "7-Zip archive + rename (.locked_sim)")) {
        & $SevenZipPath a -t7z "$zipPath" "`"$($f.FullName)`"" -p$Password -y | Out-Null
        Rename-Item -Path $f.FullName -NewName ($f.Name + ".locked_sim") -Force
      }
    } else {
      if (Test-Path $zipPath) {
        if ($PSCmdlet.ShouldProcess($zipPath, "Remove pre-existing archive")) {
          Remove-Item $zipPath -Force
        }
      }
      if ($PSCmdlet.ShouldProcess($f.FullName, "Compress-Archive + rename (.locked_sim)")) {
        Compress-Archive -Path $f.FullName -DestinationPath $zipPath -Force
        Rename-Item -Path $f.FullName -NewName ($f.Name + ".locked_sim") -Force
      }
    }
    if ($DeleteOriginals) {
      $renamedPath = Join-Path $f.DirectoryName ($f.Name + ".locked_sim")
      if (Test-Path $renamedPath) {
        $isDummy = $renamedPath -like "*\_Dummies\*"
        if ($ForceDeleteAll -or $isDummy) {
          if ($PSCmdlet.ShouldProcess($renamedPath, "Delete renamed original (simulate impact)")) {
            Remove-Item $renamedPath -Force -ErrorAction SilentlyContinue
          }
        } else {
          Write-Warning "DeleteOriginals omitido (no es dummy). Usa -ForceDeleteAll bajo tu responsabilidad."
        }
      }
    }
    $processed++
    Start-Sleep -Milliseconds $ThrottleMs
  }
  catch {
    Write-Warning "Error con '$($f.FullName)': $($_.Exception.Message)"
  }
}
Write-Output "Simulación T1486 completada en $full. Archivos procesados: $processed"
